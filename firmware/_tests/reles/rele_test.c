/* ************************************************************************** */
/* ************************************************************************** */
/* Section: Included Files                                                    */
/* ************************************************************************** */
/* ************************************************************************** */
#include "peripheral/coretimer/plib_coretimer.h"

#include "../log.h"
#include "../io_control.h"

#include "rele_test.h"

/* ************************************************************************** */
/* ************************************************************************** */
/* Section: Constants                                                         */
/* ************************************************************************** */
/* ************************************************************************** */


/* ************************************************************************** */
/* ************************************************************************** */
/* Section: Data types & Definitions                                          */
/* ************************************************************************** */
/* ************************************************************************** */


/* ************************************************************************** */
/* ************************************************************************** */
/* Section: Global data & variables                                           */
/* ************************************************************************** */
/* ************************************************************************** */
static int i;
static uint32_t time;
static int state_test = 0;

/* ************************************************************************** */
/* ************************************************************************** */
/* Section: Callback Functions                                                */
/* ************************************************************************** */
/* ************************************************************************** */


/* ************************************************************************** */
/* ************************************************************************** */
/* Section: Local Functions                                                   */
/* ************************************************************************** */
/* ************************************************************************** */


/* ************************************************************************** */
/* ************************************************************************** */
/* Section: Interface Functions                                               */
/* ************************************************************************** */

/* ************************************************************************** */
void relay_init (void)
{
  for (i = IO_OUTPUT_RELE_ID_1; i < IO_OUTPUT_MAX; i++)
    {
      io_output_set (i, IO_OUTPUT_MODE_OFF, 0, 0);
    }
  state_test = 0;
  _l ("(RELE TEST) Relay test idle.\n");
}

void relay_task (void)
{
  switch (state_test)
    {
    case 0: //idle
      break;
    case 1: //test
      if (((CORETIMER_CounterGet () - time) / CORETIMER_FrequencyGet ()) >= 3)
        {
          time = CORETIMER_CounterGet ();
          if (i < IO_OUTPUT_MAX)
            {
              _l ("(RELE TEST) %d ON! for two seconds.\n", i + 1);
              io_output_set (i, IO_OUTPUT_MODE_PULSE, 2000, 0);
              i++;
            }
          else
            {
              _l ("(RELE TEST) Test end.\n");
              state_test = 0;
            }
        }
      break;
    default:
      _l ("(RELE TEST) Que pollas haces aqui! (%d)\n", state_test);
      state_test = 0;
      break;
    }

}

void relay_test (void)
{
  time = CORETIMER_CounterGet ();
  i = IO_OUTPUT_RELE_ID_1;
  state_test = 1;
  _l ("(RELE TEST) Init test...\n");
}
/* ************************************************************** End of File */
