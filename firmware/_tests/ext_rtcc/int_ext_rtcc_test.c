/* 
 * File:   ext_rtcc_test.c
 * Author: jtrodriguez
 *
 * Created on 29 de diciembre de 2021, 13:18
 */

/* ************************************************************************** */
/* ************************************************************************** */
/* Section: Included Files                                                    */
/* ************************************************************************** */
/* ************************************************************************** */
#include "log.h"
#include "peripheral/rtcc/plib_rtcc.h"
#include "ext_rtcc/drv_mcp7940x.h"

#include "int_ext_rtcc_test.h"

/* ************************************************************************** */
/* ************************************************************************** */
/* Section: Constants                                                         */
/* ************************************************************************** */
/* ************************************************************************** */


/* ************************************************************************** */
/* ************************************************************************** */
/* Section: Data types & Definitions                                          */
/* ************************************************************************** */
/* ************************************************************************** */


/* ************************************************************************** */
/* ************************************************************************** */
/* Section: Global data & variables                                           */
/* ************************************************************************** */
/* ************************************************************************** */
static int stateRtccTest = 0;

/* ************************************************************************** */
/* ************************************************************************** */
/* Section: Callback Functions                                                */
/* ************************************************************************** */

/* ************************************************************************** */
void get_ts_cb (t_MCP7940N_CALL_BACK_CONTEXT *ctx)
{
  if (ctx->res == MCP7940N_RES_SUCCESS)
    {
      _l ("(RTCC) %02d:%02d:%02d from MCP7940N\n", ctx->ts->tm_hour, ctx->ts->tm_min, ctx->ts->tm_sec);
      RTCC_TimeSet (ctx->ts);
      stateRtccTest = 2;
    }
  else
    {
      _l ("(RTCC) data from MCP7940N not ready!\n");
      stateRtccTest = 3;
    }
}

/* ************************************************************************** */
/* ************************************************************************** */
/* Section: Local Functions                                                   */
/* ************************************************************************** */
/* ************************************************************************** */


/* ************************************************************************** */
/* ************************************************************************** */
/* Section: Interface Functions                                               */
/* ************************************************************************** */

/* ************************************************************************** */
void int_ext_rtcc_test_init (void)
{
  drv_mcp7940n_initialize ();
}

void int_ext_rtcc_test_task (void)
{
  static struct tm ts;
  static int mAux;

  drv_mcp7940n_tasks ();
  switch (stateRtccTest)
    {
    case 0:
      if (mcp7940n_get_state () == MCP7940N_STATE_IDLE)
        {
          _l ("(RTCC) Requesting data from MCP7940N...\n");
          mcp7940n_get_ts (get_ts_cb);
          mAux = 0;
          stateRtccTest = 1;
        }
      break;
    case 1:
      break;
    case 2:
      RTCC_TimeGet (&ts);
      if (ts.tm_min != mAux)
        {
          mAux = ts.tm_min;
          _l ("(RTCC) %02d:%02d:%02d\n", ts.tm_hour, ts.tm_min, ts.tm_sec);
        }
      break;
    default:
      break;
    }
}

/* ************************************************************** End of File */
